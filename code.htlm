<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Zetamac Tracker with Google Sheets</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .bookmarklet-section {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
            color: white;
        }
        .bookmarklet-section h3 {
            margin-top: 0;
            font-size: 1.5em;
        }
        .bookmarklet {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            display: inline-block;
            margin: 15px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .bookmarklet:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
            text-decoration: none;
        }
        .setup-section {
            background: #f8f9fc;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
            border-left: 5px solid #ff6b6b;
        }
        .instructions {
            background: #f8f9fc;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
            border-left: 5px solid #4facfe;
        }
        .instructions h3, .setup-section h3 {
            color: #2d3748;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .instructions ol, .setup-section ol {
            padding-left: 20px;
        }
        .instructions li, .setup-section li {
            margin: 10px 0;
            line-height: 1.6;
        }
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .feature-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        .feature-card h4 {
            color: #2d3748;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 15px 0;
            overflow-x: auto;
        }
        .note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .note h4 {
            margin-top: 0;
        }
        .warning {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ Advanced Zetamac Tracker</h1>
        <p class="subtitle">Track individual questions with timestamps and sync directly to Google Sheets</p>
        
        <div class="setup-section">
            <h3>ðŸ”§ Google Sheets Setup (Detailed Instructions)</h3>
            <p><strong>Follow these exact steps to fix the HTTP 401 error:</strong></p>
            <ol>
                <li><strong>Go to <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></strong></li>
                <li><strong>Create a new project:</strong> Click "Select a project" â†’ "New Project" â†’ Name it "Zetamac Tracker"</li>
                <li><strong>Enable Google Sheets API:</strong>
                    <br>â€¢ Go to "APIs & Services" â†’ "Library"
                    <br>â€¢ Search for "Google Sheets API" 
                    <br>â€¢ Click it and press "Enable"
                </li>
                <li><strong>Create API Credentials:</strong>
                    <br>â€¢ Go to "APIs & Services" â†’ "Credentials"
                    <br>â€¢ Click "Create Credentials" â†’ "API Key"
                    <br>â€¢ <strong>Important:</strong> Click "Restrict Key"
                    <br>â€¢ Under "API restrictions" â†’ "Restrict key" â†’ Select "Google Sheets API"
                    <br>â€¢ Under "Application restrictions" â†’ "HTTP referrers" â†’ Add: <code>https://arithmetic.zetamac.com/*</code>
                    <br>â€¢ Save the API key
                </li>
                <li><strong>Create Google Sheet:</strong>
                    <br>â€¢ Go to <a href="https://sheets.google.com" target="_blank">Google Sheets</a>
                    <br>â€¢ Create a new blank spreadsheet
                    <br>â€¢ <strong>IMPORTANT:</strong> Click "Share" â†’ "Change to anyone with the link can VIEW"
                    <br>â€¢ Copy the Sheet ID from the URL
                </li>
            </ol>
            <div class="code-block">
Example Google Sheet URL:<br>
https://docs.google.com/spreadsheets/d/<strong>1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms</strong>/edit<br><br>
The Sheet ID is: <strong>1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms</strong>
            </div>
            <div class="warning">
                <h4>ðŸ”‘ Critical Steps to Fix HTTP 401:</h4>
                <ul>
                    <li><strong>Sheet Permissions:</strong> MUST set sheet to "Anyone with link can VIEW" (not edit)</li>
                    <li><strong>API Restrictions:</strong> Restrict API key to only Google Sheets API</li>
                    <li><strong>HTTP Referrers:</strong> Add https://arithmetic.zetamac.com/* as allowed referrer</li>
                    <li><strong>Wait 2-3 minutes</strong> after creating API key for it to become active</li>
                </ul>
            </div>
        </div>

        <div class="bookmarklet-section">
            <h3>ðŸ“Ž Install the Enhanced Tracker</h3>
            <p>Drag this button to your browser's bookmarks bar:</p>
            
            <a href='javascript:(function(){if(window.zetamacAdvanced){window.zetamacAdvanced.toggle();return;}var tracker={isRecording:false,sessions:[],currentSession:null,popup:null,observer:null,urlObserver:null,questionObserver:null,lastQuestion:"",lastAnswer:"",questionCount:0,apiKey:"",sheetId:"",init:function(){this.createPopup();this.startTracking();this.trackUrlChanges();},createPopup:function(){this.popup=document.createElement("div");this.popup.style.cssText="position:fixed;top:10px;right:10px;width:400px;background:white;border:2px solid #007bff;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.3);z-index:999999;font-family:Arial,sans-serif;font-size:13px;max-height:90vh;overflow-y:auto;";this.popup.innerHTML="<div style=\"background:#007bff;color:white;padding:15px;font-weight:bold;border-radius:10px 10px 0 0;position:relative;\">ðŸŽ¯ Advanced Zetamac Tracker<button id=\"zta-close-btn\" style=\"position:absolute;top:10px;right:10px;background:none;border:none;color:white;font-size:20px;cursor:pointer;\">Ã—</button></div><div style=\"padding:15px;\"><div id=\"zta-setup\" style=\"background:#fff3cd;padding:10px;border-radius:6px;margin-bottom:15px;\"><div style=\"font-weight:bold;margin-bottom:8px;\">âš™ï¸ Setup Required</div><input id=\"zta-api-key\" placeholder=\"Google Sheets API Key\" style=\"width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;\"><input id=\"zta-sheet-id\" placeholder=\"Google Sheet ID\" style=\"width:100%;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;\"><button id=\"zta-save-config\" style=\"background:#28a745;color:white;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:12px;\">Save Config</button></div><div style=\"margin-bottom:15px;\"><button id=\"zta-record-btn\" style=\"background:#6c757d;color:white;border:none;padding:12px 18px;border-radius:6px;cursor:pointer;margin-right:8px;font-size:13px;\" disabled>â–¶ Start Recording</button><button id=\"zta-sync-btn\" style=\"background:#6c757d;color:white;border:none;padding:12px 18px;border-radius:6px;cursor:pointer;font-size:13px;\" disabled>ðŸ”„ Sync to Sheets</button></div><div id=\"zta-url-status\" style=\"margin-bottom:10px;font-size:11px;color:#666;background:#f8f9fa;padding:8px;border-radius:4px;font-family:monospace;\">Main page ready</div><div id=\"zta-status\" style=\"margin-bottom:12px;font-weight:bold;color:#666;font-size:13px;\">Setup required to begin</div><div id=\"zta-session-display\" style=\"background:#f8f9fa;border:1px solid #dee2e6;border-radius:6px;padding:12px;max-height:200px;overflow-y:auto;font-size:12px;\">Complete setup to start tracking questions</div></div>";document.body.appendChild(this.popup);var self=this;document.getElementById("zta-record-btn").onclick=function(){self.toggleRecording();};document.getElementById("zta-sync-btn").onclick=function(){self.syncToSheets();};document.getElementById("zta-close-btn").onclick=function(){self.close();};document.getElementById("zta-save-config").onclick=function(){self.saveConfig();};this.loadConfig();},saveConfig:function(){this.apiKey=document.getElementById("zta-api-key").value.trim();this.sheetId=document.getElementById("zta-sheet-id").value.trim();if(this.apiKey&&this.sheetId){document.getElementById("zta-setup").style.display="none";document.getElementById("zta-record-btn").disabled=false;document.getElementById("zta-record-btn").style.background="#28a745";document.getElementById("zta-sync-btn").disabled=false;document.getElementById("zta-sync-btn").style.background="#007bff";this.updateStatus("âœ… Setup complete - ready to record!");alert("âœ… Configuration saved! You can now start recording.");}else{alert("âŒ Please enter both API Key and Sheet ID");}},loadConfig:function(){var saved=localStorage.getItem("zetamac-config");if(saved){try{var config=JSON.parse(saved);this.apiKey=config.apiKey||"";this.sheetId=config.sheetId||"";if(this.apiKey&&this.sheetId){document.getElementById("zta-api-key").value=this.apiKey;document.getElementById("zta-sheet-id").value=this.sheetId;this.saveConfig();}}catch(e){}}},trackUrlChanges:function(){var self=this;setInterval(function(){self.updateUrlStatus();},500);},startTracking:function(){var self=this;this.observer=new MutationObserver(function(mutations){if(self.isRecording){self.checkForQuestion();self.checkForAnswer();}});this.observer.observe(document.body,{childList:true,subtree:true,characterData:true});},checkForQuestion:function(){var questionElements=document.querySelectorAll("*");var currentQuestion="";for(var i=0;i<questionElements.length;i++){var elem=questionElements[i];var text=(elem.textContent||"").trim();if(text.match(/^\d+[\+\-\*\/Ã—Ã·]\d+$|^\d+\s*[\+\-\*\/Ã—Ã·]\s*\d+$/)){currentQuestion=text;break;}}if(currentQuestion&&currentQuestion!==this.lastQuestion){this.lastQuestion=currentQuestion;this.questionCount++;this.recordQuestion(currentQuestion);}},checkForAnswer:function(){var inputs=document.querySelectorAll("input");var currentAnswer="";for(var i=0;i<inputs.length;i++){var input=inputs[i];if(input.type==="text"||input.type==="number"){currentAnswer=input.value.trim();break;}}if(currentAnswer&&currentAnswer!==this.lastAnswer&&!isNaN(currentAnswer)){this.lastAnswer=currentAnswer;if(this.currentSession&&this.currentSession.questions.length>0){var lastQ=this.currentSession.questions[this.currentSession.questions.length-1];if(!lastQ.answer){lastQ.answer=currentAnswer;lastQ.answerTime=new Date().toISOString();lastQ.responseTime=new Date().getTime()-new Date(lastQ.timestamp).getTime();this.updateDisplay();}}}},recordQuestion:function(question){if(!this.currentSession)return;var timestamp=new Date();var questionData={questionNumber:this.questionCount,question:question,timestamp:timestamp.toISOString(),displayTime:timestamp.toLocaleString(),answer:"",answerTime:"",responseTime:0};this.currentSession.questions.push(questionData);this.updateDisplay();this.updateStatus("ðŸ“ Question "+this.questionCount+": "+question);},getGameKey:function(){var url=window.location.href;var match=url.match(/[?&]key=([a-f0-9]+)/i);return match?match[1]:"no-key";},toggleRecording:function(){this.isRecording=!this.isRecording;var btn=document.getElementById("zta-record-btn");if(this.isRecording){this.startNewSession();btn.innerHTML="â¹ Stop Recording";btn.style.background="#dc3545";this.updateStatus("ðŸ”´ Recording questions and answers...");}else{this.endCurrentSession();btn.innerHTML="â–¶ Start Recording";btn.style.background="#28a745";this.updateStatus("â¸ Recording stopped");document.getElementById("zta-sync-btn").style.background="#007bff";}},startNewSession:function(){this.currentSession={gameKey:this.getGameKey(),startTime:new Date().toISOString(),endTime:"",questions:[],finalScore:0};this.questionCount=0;this.lastQuestion="";this.lastAnswer="";},endCurrentSession:function(){if(this.currentSession){this.currentSession.endTime=new Date().toISOString();var scoreText=document.body.textContent||"";var scoreMatch=scoreText.match(/Score:\s*(\d+)/);this.currentSession.finalScore=scoreMatch?parseInt(scoreMatch[1]):0;this.sessions.push(this.currentSession);this.currentSession=null;}},updateUrlStatus:function(){var urlStatus=document.getElementById("zta-url-status");if(urlStatus){var gameKey=this.getGameKey();if(gameKey==="no-key"){urlStatus.innerHTML="ðŸ“ Main page (ready to start game)";}else{urlStatus.innerHTML="ðŸŽ® Game active (Key: "+gameKey+")";}}},updateDisplay:function(){var display=document.getElementById("zta-session-display");if(!this.isRecording&&this.sessions.length===0){display.innerHTML="<em style=\"color:#6c757d;\">No sessions recorded yet...</em>";return;}var html="";if(this.isRecording&&this.currentSession){html+="<div style=\"font-weight:bold;color:#dc3545;margin-bottom:8px;\">ðŸ”´ Current Session ("+this.currentSession.questions.length+" questions)</div>";if(this.currentSession.questions.length>0){var recent=this.currentSession.questions.slice(-3);recent.forEach(function(q){var responseText=q.answer?(" â†’ "+q.answer+" ("+q.responseTime+"ms)"):" (waiting for answer)";html+="<div style=\"background:white;margin:3px 0;padding:6px;border-radius:3px;border-left:3px solid #dc3545;font-size:11px;\">Q"+q.questionNumber+": "+q.question+responseText+"</div>";});if(this.currentSession.questions.length>3){html+="<div style=\"text-align:center;margin:5px 0;color:#666;font-style:italic;font-size:10px;\">+ "+(this.currentSession.questions.length-3)+" more questions</div>";}}else{html+="<div style=\"color:#666;font-style:italic;\">Waiting for questions...</div>";}}if(this.sessions.length>0){html+="<div style=\"font-weight:bold;color:#495057;margin:10px 0 5px 0;\">ðŸ“Š Completed Sessions ("+this.sessions.length+")</div>";var recentSessions=this.sessions.slice(-2);recentSessions.forEach(function(session){html+="<div style=\"background:#e8f5e8;margin:4px 0;padding:8px;border-radius:4px;border-left:3px solid #28a745;\"><div style=\"font-weight:bold;font-size:11px;\">Score: "+session.finalScore+" | "+session.questions.length+" questions</div><div style=\"font-size:10px;color:#666;\">Key: "+session.gameKey+"</div></div>";});}display.innerHTML=html;display.scrollTop=display.scrollHeight;},updateStatus:function(message){var status=document.getElementById("zta-status");if(status){status.textContent=message;}},syncToSheets:function(){if(this.sessions.length===0){alert("No data to sync!");return;}if(!this.apiKey||!this.sheetId){alert("Please configure Google Sheets API first!");return;}this.updateStatus("ðŸ”„ Syncing to Google Sheets...");var self=this;this.createSheetHeaders().then(function(){return self.uploadSessions();}).then(function(){self.updateStatus("âœ… Sync completed successfully!");alert("âœ… Data synced to Google Sheets successfully!");}).catch(function(error){self.updateStatus("âŒ Sync failed: "+error.message);alert("âŒ Sync failed: "+error.message);});},createSheetHeaders:function(){var headerData=[["Session","Game Key","Start Time","End Time","Final Score","Question Number","Question","Answer","Question Time","Answer Time","Response Time (ms)"]];return this.writeToSheet("A1:K1",headerData);},uploadSessions:function(){var allData=[];var self=this;this.sessions.forEach(function(session,sessionIndex){session.questions.forEach(function(question){allData.push([sessionIndex+1,session.gameKey,session.startTime,session.endTime,session.finalScore,question.questionNumber,question.question,question.answer||"",question.timestamp,question.answerTime||"",question.responseTime||0]);});});return this.writeToSheet("A2:K"+(allData.length+1),allData);},writeToSheet:function(range,values){var url="https://sheets.googleapis.com/v4/spreadsheets/"+this.sheetId+"/values/"+range+"?valueInputOption=RAW&key="+this.apiKey;return fetch(url,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({values:values})}).then(function(response){if(!response.ok){throw new Error("HTTP "+response.status);}return response.json();});},close:function(){if(this.observer){this.observer.disconnect();}if(this.popup&&this.popup.parentNode){this.popup.parentNode.removeChild(this.popup);}delete window.zetamacAdvanced;},toggle:function(){if(this.popup&&this.popup.parentNode){this.close();}else{this.init();}}};window.zetamacAdvanced=tracker;tracker.init();})()' class="bookmarklet">ðŸš€ Advanced Zetamac Tracker</a>
        </div>

        <div class="instructions">
            <h3>ðŸ“‹ How to Use the Enhanced Tracker</h3>
            <ol>
                <li><strong>Complete Google Sheets setup</strong> (see setup section above)</li>
                <li><strong>Install:</strong> Drag the bookmarklet to your browser's bookmarks bar</li>
                <li><strong>Navigate:</strong> Go to <strong>arithmetic.zetamac.com</strong></li>
                <li><strong>Configure:</strong> Click the bookmarklet and enter your API key and Sheet ID</li>
                <li><strong>Record:</strong> Click "â–¶ Start Recording" BEFORE starting a game</li>
                <li><strong>Play:</strong> Play games normally - every question and answer is tracked</li>
                <li><strong>Sync:</strong> Click "ðŸ”„ Sync to Sheets" to upload data directly to Google Sheets</li>
            </ol>
        </div>

        <div class="features">
            <div class="feature-card">
                <h4>ðŸ“ Question-Level Tracking</h4>
                <p>Captures every individual question that appears during gameplay with precise timestamps.</p>
            </div>
            <div class="feature-card">
                <h4>â±ï¸ Response Time Analysis</h4>
                <p>Measures how long it takes you to answer each question in milliseconds.</p>
            </div>
            <div class="feature-card">
                <h4>ðŸŽ¯ Answer Accuracy</h4>
                <p>Records your answers to each question for accuracy analysis.</p>
            </div>
            <div class="feature-card">
                <h4>ðŸ“Š Direct Google Sheets Sync</h4>
                <p>Uploads data directly to your Google Sheet with structured columns for analysis.</p>
            </div>
            <div class="feature-card">
                <h4>ðŸŽ® Multi-Session Support</h4>
                <p>Tracks multiple game sessions with separate game keys and scores.</p>
            </div>
            <div class="feature-card">
                <h4>ðŸ“ˆ Advanced Analytics Ready</h4>
                <p>Data is structured for pivot tables, charts, and statistical analysis in Google Sheets.</p>
            </div>
        </div>

        <div class="note">
            <h4>ðŸ“Š Google Sheets Data Structure</h4>
            <p>Your data will be organized in Google Sheets with these columns:</p>
            <ul>
                <li><strong>Session:</strong> Session number for grouping games</li>
                <li><strong>Game Key:</strong> Unique identifier for each game</li>
                <li><strong>Start/End Time:</strong> When the game session began and ended</li>
                <li><strong>Final Score:</strong> Your final score for the game</li>
                <li><strong>Question Number:</strong> Sequential number of each question</li>
                <li><strong>Question:</strong> The actual math problem (e.g., "15+23")</li>
                <li><strong>Answer:</strong> Your submitted answer</li>
                <li><strong>Question/Answer Time:</strong> Timestamps for question display and answer submission</li>
                <li><strong>Response Time:</strong> Milliseconds taken to answer each question</li>
            </ul>
        </div>

        <div class="warning">
            <h4>ðŸ”’ API Key Security</h4>
            <p><strong>Important:</strong> Your API key will be stored in your browser's local storage. For maximum security:</p>
            <ul>
                <li>Only use this on your personal computer</li>
                <li>Consider restricting your API key to specific IP addresses in Google Cloud Console</li>
                <li>Set usage quotas to prevent unexpected charges</li>
                <li>The tracker only accesses your specified Google Sheet</li>
            </ul>
        </div>
    </div>
</body>
</html>
